{plugins,[{relup_helper,{git,"https://github.com/emqx/relup_helper",
                             {branch,"master"}}}]}.
{edge_relx_overlay,[]}.
{edoc_opts,[{preprocess,true}]}.
{erl_opts,[warn_unused_vars,warn_shadow_vars,warn_unused_import,
           warn_obsolete_guard,no_debug_info,compressed]}.
{overrides,[{add,[{erl_opts,[no_debug_info,compressed,
                             {parse_transform,mod_vsn}]}]}]}.
{xref_checks,[undefined_function_calls,undefined_functions,locals_not_used,
              deprecated_function_calls,warnings_as_errors,
              deprecated_functions]}.
{cover_enabled,true}.
{cover_opts,[verbose]}.
{cover_export_enabled,true}.
{provider_hooks,[{pre,[{release,{relup_helper,gen_appups}}]},
                 {post,[{release,{relup_helper,otp_vsn}},
                        {release,{relup_helper,untar}}]}]}.
{post_hooks,[{"(linux|darwin|solaris|freebsd|netbsd|openbsd)",compile,
              "./post-compile.sh"},
             {"win32",compile,"post-compile.cmd"}]}.

"${COVERALL_CONFIGS}".

{profiles,
    [{'emqx',
        [{deps, []},
         {relx,
             ["${BASIC_RELX_PARAMS}",
              {release, {emqx, "${GIT_DESC}"}, ["${BASIC_RELX_APPS}", "${CLOUD_RELX_APPS}"]},
              {overlay, ["${BASIC_OVERLAYS}", "${CLOUD_OVERLAYS}"]},
              {overlay_vars,["vars-cloud.config","vars-bin.config"]}]}]},
     {'emqx-pkg',
         [{deps, []},
          {relx,
              ["${BASIC_RELX_PARAMS}",
               {release, {emqx, "${GIT_DESC}"}, ["${BASIC_RELX_APPS}", "${CLOUD_RELX_APPS}"]},
               {overlay, ["${BASIC_OVERLAYS}", "${CLOUD_OVERLAYS}"]},
               {overlay_vars,["vars-cloud.config","vars-pkg.config"]}]}]},
     {'emqx-edge',
         [{deps, []},
          {relx,
              ["${BASIC_RELX_PARAMS}",
               {release, {emqx, "${GIT_DESC}"}, ["${BASIC_RELX_APPS}"]},
               {overlay, ["${BASIC_OVERLAYS}", "${EDGE_OVERLAYS}"]},
               {overlay_vars,["vars-edge.config","vars-bin.config"]}]}]},
     {'emqx-edge-pkg',
         [{deps, []},
          {relx,
              ["${BASIC_RELX_PARAMS}",
               {release, {emqx, "${GIT_DESC}"}, ["${BASIC_RELX_APPS}"]},
               {overlay, ["${BASIC_OVERLAYS}", "${EDGE_OVERLAYS}"]},
               {overlay_vars,["vars-edge.config","vars-pkg.config"]}]}]}
    ]}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Placeholders
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
{rebar_place_holders, [

  {"BASIC_RELX_PARAMS", elems,
    [ {include_src,false}
    , {extended_start_script,false}
    , {generate_start_script,false}
    , {sys_config,false}
    , {vm_args,false}
    ]
  },

  {"BASIC_RELX_APPS", elems,
    [ kernel
    , sasl
    , crypto
    , public_key
    , asn1
    , syntax_tools
    , ssl
    , os_mon
    , inets
    , compiler
    , runtime_tools
    , cuttlefish
    , emqx
    , {mnesia, load}
    , {ekka, load}
    , {emqx_retainer, load}
    , {emqx_management, load}
    , {emqx_dashboard, load}
    , {emqx_bridge_mqtt, load}
    , {emqx_sn, load}
    , {emqx_coap, load}
    , {emqx_stomp, load}
    , {emqx_auth_clientid, load}
    , {emqx_auth_username, load}
    , {emqx_auth_http, load}
    , {emqx_auth_mysql, load}
    , {emqx_auth_jwt, load}
    , {emqx_auth_mnesia, load}
    , {emqx_web_hook, load}
    , {emqx_recon, load}
    , {emqx_rule_engine, load}
    , {emqx_sasl, load}
    , {emqx_telemetry, load}
    ]
  },

  {"CLOUD_RELX_APPS", elems,
    [ {emqx_lwm2m, load}
    , {emqx_auth_ldap, load}
    , {emqx_auth_pgsql, load}
    , {emqx_auth_redis, load}
    , {emqx_auth_mongo, load}
    , {emqx_lua_hook, load}
    , {emqx_extension_hook, load}
    , {emqx_exproto, load}
    , {emqx_prometheus, load}
    , {emqx_reloader, load}
    , {emqx_psk_file, load}
    , {emqx_plugin_template, load}
    , {observer, load}
    , luerl
    , xmerl
    ]
  },

  {"BASIC_OVERLAYS", elems,
    [ {mkdir,"etc/"}
    , {mkdir,"log/"}
    , {mkdir,"data/"}
    , {mkdir,"data/mnesia"}
    , {mkdir,"data/configs"}
    , {mkdir,"data/scripts"}
    , {template, "data/loaded_plugins.tmpl", "data/loaded_plugins"}
    , {template, "data/loaded_modules.tmpl", "data/loaded_modules"}
    , {template,"data/emqx_vars","releases/emqx_vars"}
    , {copy,"bin/*","bin/"}
    , {template,"etc/*.conf","etc/"}
    , {template,"etc/emqx.d/*.conf","etc/emqx.d/"}
    , {copy,"etc/schema/*.schema","releases/{{rel_vsn}}/schema/"}
    , {copy, "etc/certs","etc/"}
    , "${RELUP_OVERLAYS}"
    ]
  },

  {"RELUP_OVERLAYS", elems,
    [ {copy,"bin/emqx.cmd","bin/emqx.cmd-{{rel_vsn}}"}
    , {copy,"bin/emqx_ctl.cmd","bin/emqx_ctl.cmd-{{rel_vsn}}"}
    , {copy,"bin/emqx","bin/emqx-{{rel_vsn}}"}
    , {copy,"bin/emqx_ctl","bin/emqx_ctl-{{rel_vsn}}"}
    , {copy,"bin/install_upgrade.escript", "bin/install_upgrade.escript-{{rel_vsn}}"}
    , {copy,"bin/nodetool","bin/nodetool-{{rel_vsn}}"}
    , {copy,"bin/cuttlefish","bin/cuttlefish-{{rel_vsn}}"}
    ]
  },

  {"CLOUD_OVERLAYS", elems,
    [ {template,"etc/emqx_cloud.d/*.conf","etc/emqx.d/"}
    , {template,"etc/vm.args","etc/vm.args"}
    ]
  },

  {"EDGE_OVERLAYS", elems,
    [ {template,"etc/emqx_edge.d/*.conf","etc/emqx.d/"}
    , {template,"etc/vm.args.edge","etc/vm.args"}
    ]
  },

  {"GIT_DESC", var, fun 'rebar.config.mod':get_vsn/1},

  {"COVERALL_CONFIGS", elems, fun 'rebar.config.mod':coveralls_configs/1}

]}.

